Post Mortem Report

Инцидент: отказ веб-сервиса Apache / MediaWiki из-за переполнения диска

Действия:

1. Проверка проблемы
   Первым шагом было проверено, что сайт действительно недоступен 
   по URL/IP — веб-приложение не открывается.

2. Подключение к серверу
   Выполнено подключение к серверу по SSH под пользователем ec2-user.
3. Проверка статуса web-сервиса
   Проверен статус Apache:

sudo service httpd status
используем sudо, чтобы получить необходимые привилегии в доступе.

Сервис не работал / находился в некорректном состоянии.

4. Попытка запуска сервиса

sudo service httpd restart

5. Повторная проверка статуса
   sudo service httpd status

Сервис запускается, но сайт по-прежнему недоступен.

6. Анализ поведения сервиса

При попытке открытия сайта наблюдается переадресация на некорректный IP-адрес.
Причина: сервер развернут в Amazon EC2, где IP-адрес меняется после рестарта виртуальной машины.

7. Проверка конфигурации приложения

Настройки MediaWiki находятся в файле LocalSettings.php.
Файл конфигурации найден в домашней директории:
/home/ec2-user/LocalSettings (5).php
Для корректной работы он должен лежать в:
/var/www/html/mediawiki/LocalSettings.php

8. Попытка копирования конфигурации
   cp LocalSettings\ \(5\).php /var/www/html/mediawiki/LocalSettings.php

Результат
Получена ошибка — нет свободного места на диске.

9. Проверка дискового пространства
   df -h

Выявлено, что файловая система заполнена.

10. Поиск крупных файлов
    sudo find / -type f -size +100M -exec du -h {} \;

11. Выявление причины

Обнаружен файл:

/var/log/httpd/access_log-20260106

Очень большого размера.

Пояснение

Access log — журнал работы web-сервера, в который Apache записывает все HTTP-запросы, которые он обрабатывает.

12. Освобождение места

Удалён крупный лог-файл:

sudo rm -rf /var/log/httpd/access_log-20260106

Повторная проверка:

df -h

Свободное место появилось.

13. Повторное копирование конфигурации
    cp LocalSettings\ \(5\).php /var/www/html/mediawiki/LocalSettings.php

14. Проверка и правка IP-адреса

Открыт файл конфигурации:

sudo nano /var/www/html/mediawiki/LocalSettings.php

Найдена переменная с IP-адресом сервера.
Адрес был устаревшим, исправлен на актуальный.

15. Перезапуск сервиса
    sudo service httpd restart

16. Проверка результата

Переход по корректному IP/URL — сайт работает, сервер восстановлен.

Поиск первопричины инцидента:

17. Анализ логов и времени создания файлов

Замечено, что архивы логов:
создаются каждую минуту, имеют большой размер,
время создания совпадает с моментом падения сервера

18. Проверка cron-задач
    crontab -l
    sudo crontab -l

        Проблема:

    в crontab была обнаружена задача с расписанием:

* * * * * ( пять звездочек)

Скрипт выполнялся каждую минуту, архивировал access log и ранее созданные архивы, 

что приводило к быстрому росту объёма данных и переполнению диска.

Также была возможность использовать sudo su, что является потенциальной

 уязвимостью системы безопасности, так как предоставляет полный root-доступ.

19. Отключение проблемного cron
    crontab -e

Задача закомментирована.

20. Очистка системы

Удалены старые архивы:

rm -rf /var/log/httpd/\*.gz
rm -rf backup_httpd/

Проверка:

df -h

Свободное место подтверждено.

Реализация корректного решения

21. Создание корректного backup-скрипта

Создан скрипт:

/home/ec2-user/backup_logs.sh

В скрипте:

архивируется /var/log/httpd/access_log
архив складывается в отдельную директорию
access log очищается
Скрипт сделан исполняемым:

chmod +x backup_logs.sh

Проверен вручную на персональном компьютере ( не сервере) — работает корректно.

22. Добавление cron-задачи

Добавлено расписание:

crontab -e

5 3 \* \* \*

/home/ec2-user/backup_logs.sh

Скрипт выполняется каждый день в 03:05 ночи.

Что это даёт - лог архивируется один раз в день, лог начинается заново, диск не переполняется,

подобрано удобное время с точки загрузки сервера,

сервер стабилен.



Рекомендации по улучшению процессов

На основе анализа инцидента рекомендуется:

- Автоматизировать контроль дискового пространства:
настроить мониторинг использования диска с отправкой уведомлений администратору
при превышении заданного порога (например, 80–90%). Уведомления могут отправляться 
через Telegram-бота, email или систему мониторинга.

- Документировать все cron-задачи и регулярно проводить их аудит, чтобы исключить
некорректные или избыточные автоматические задания.

- Исключить использование sudo su, ограничив доступ к root-пользователю и применяя
принцип минимально необходимых привилегий.

- При использовании Amazon EC2 закреплять Elastic IP, чтобы избежать проблем
с изменением IP-адреса после перезапуска экземпляра.



